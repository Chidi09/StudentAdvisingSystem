<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Crawford Advising</title>
    <link rel="stylesheet" href="../css/style.css"> </head>
<body class="dashboard-page"> <main class="login-page-container"> 
        <div class="login-card">
            <header class="login-card-header">
                <h1>Crawford University</h1>
                <p class="subtitle">Change Your Password</p>
                <div style="position: absolute; top: 20px; right: 20px;">
                    <button id="theme-toggle-button" class="theme-toggle-btn">🌙</button>
                </div>
            </header>

            <section class="login-card-body">
                <h2>Update Password</h2>
                <form id="change-password-form">
                    <div class="input-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" name="current_password" required autocomplete="current-password">
                    </div>

                    <div class="input-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="new_password" required autocomplete="new-password">
                    </div>

                    <div class="input-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" name="confirm_password" required autocomplete="new-password">
                    </div>

                    <button type="submit" class="submit-btn">Change Password</button>

                    <div id="change-password-message-area" class="message-display" style="margin-top: 15px; min-height: 1em; text-align: center;">
                        </div>
                </form>
                <div id="dashboard-link-container" style="text-align: center; margin-top: 20px;">
                     <a id="back-to-dashboard-link" href="#" class="styled-link">Back to Dashboard</a>
                </div>
            </section>

            <footer class="login-card-footer">
                <p>&copy; 2025 Crawford University. All rights reserved.</p>
            </footer>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Change Password DOM loaded.");

            // --- THEME TOGGLE LOGIC ---
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const bodyElement = document.body;

            function applyCurrentTheme() {
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'dark') {
                    bodyElement.classList.add('dark-mode');
                    if(themeToggleButton) themeToggleButton.textContent = '☀️';
                } else {
                    bodyElement.classList.remove('dark-mode'); // Ensure it's light if not set or 'light'
                    if(themeToggleButton) themeToggleButton.textContent = '🌙';
                }
            }
            
            if (themeToggleButton && bodyElement) {
                applyCurrentTheme(); // Apply theme on initial load

                themeToggleButton.addEventListener('click', () => {
                    bodyElement.classList.toggle('dark-mode');
                    let newTheme = bodyElement.classList.contains('dark-mode') ? 'dark' : 'light';
                    themeToggleButton.textContent = newTheme === 'dark' ? '☀️' : '🌙';
                    localStorage.setItem('theme', newTheme);
                    console.log("Theme toggled on Change Password page to:", newTheme);
                });
            } else {
                if (!themeToggleButton) console.warn("Theme toggle button (#theme-toggle-button) not found.");
                if (!bodyElement) console.warn("Body element not found for theme toggle.");
            }
            // --- END THEME TOGGLE LOGIC ---

            // --- TOKEN/USER INFO RETRIEVAL & AUTH CHECK ---
            const accessToken = localStorage.getItem('accessToken');
            const userType = localStorage.getItem('userType'); 
            const messageArea = document.getElementById('change-password-message-area'); // Get message area early

            if (!accessToken) {
                console.error("No access token found. Redirecting to login.");
                if(messageArea) {
                    messageArea.textContent = "Session expired or not logged in. Please log in again.";
                    messageArea.className = 'message-display error visible';
                } else {
                    alert("Session expired or not logged in. Please log in again.");
                }
                // Redirect after a short delay to allow user to see message
                setTimeout(() => {
                     localStorage.clear(); 
                     window.location.href = '../index.html'; // Adjust path if needed
                }, 2500);
                // Disable form submission if not authenticated
                const changePasswordFormBtn = document.querySelector('#change-password-form button[type="submit"]');
                if(changePasswordFormBtn) changePasswordFormBtn.disabled = true;
                return; 
            }

            // --- "BACK TO DASHBOARD" LINK SETUP ---
            const backToDashboardLink = document.getElementById('back-to-dashboard-link');
            if (backToDashboardLink) {
                if (userType === 'student') {
                    backToDashboardLink.href = '../student/dashboard.html'; // Adjust path
                } else if (userType === 'lecturer') {
                    backToDashboardLink.href = '../lecturer/dashboard.html'; // Adjust path
                } else {
                    backToDashboardLink.href = '../index.html'; // Fallback
                    console.warn("Unknown userType from localStorage, 'Back to Dashboard' link set to login page.");
                }
            } else {
                console.warn("Element #back-to-dashboard-link not found.");
            }

            // --- FORM ELEMENTS & SUBMIT HANDLER ---
            const changePasswordForm = document.getElementById('change-password-form');
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            // messageArea already defined above

            if (changePasswordForm && currentPasswordInput && newPasswordInput && confirmPasswordInput && messageArea) {
                changePasswordForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); 
                    
                    messageArea.textContent = 'Processing...';
                    messageArea.className = 'message-display visible'; // Use classes for styling, remove old ones first
                    messageArea.style.color = ''; // Reset direct style if any from previous attempts

                    const currentPassword = currentPasswordInput.value;
                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    // Frontend Validation
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        messageArea.textContent = 'All password fields are required.';
                        messageArea.className = 'message-display error visible';
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        messageArea.textContent = 'New password and confirmation do not match.';
                        messageArea.className = 'message-display error visible';
                        return;
                    }
                    // Add password length/complexity checks if desired (should also be on backend)
                    if (newPassword.length < 7) { // Example: Min 7 characters
                        messageArea.textContent = 'New password must be at least 7 characters long.';
                        messageArea.className = 'message-display error visible';
                        return;
                    }

                    const payload = {
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword 
                    };

                    const apiUrl = 'http://127.0.0.1:5000/api/me/change-password'; // Ensure this backend endpoint exists
                    console.log("Sending change password request with payload:", payload);

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`, 
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json(); // Attempt to parse JSON for message
                        console.log("Backend response to change password:", result);

                        if (response.ok && result.success) { // Check for HTTP OK and backend 'success' flag
                            messageArea.textContent = result.message || "Password changed successfully! You may need to log in again.";
                            messageArea.className = 'message-display success visible';
                            changePasswordForm.reset(); 
                        } else {
                            messageArea.textContent = result.message || 'Failed to change password. Please check current password and try again.';
                            messageArea.className = 'message-display error visible';
                        }

                    } catch (error) {
                        console.error("Network error changing password:", error);
                        messageArea.textContent = 'A network error occurred. Please check your connection.';
                        messageArea.className = 'message-display error visible';
                    }
                });
            } else {
                if (!changePasswordForm) console.error("Change password form (#change-password-form) not found!");
                if (!currentPasswordInput) console.error("Current password input (#current-password) not found!");
                // ... etc. for other inputs ...
                if (!messageArea) console.error("Message area (#change-password-message-area) not found!");
            }
        });
    </script>
</body>
</html>