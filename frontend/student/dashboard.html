<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Crawford Advising</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="dashboard-page">

    <nav class="dashboard-nav">
        <div class="nav-links">
            <a href="dashboard.html" class="active">Dashboard</a>
            <a href="courses.html">Courses</a>
            <a href="results.html">Results</a> <!-- Link to Results page -->
            <a href="profile.html">Profile</a>
            <a href="../auth/change_password.html">Change Password</a>
            <a href="../resources/resources.html">Resources</a>
        </div>
        <div class="user-actions">
            <button id="theme-toggle-button" class="theme-toggle-btn" style="margin-right: 10px;">🌙</button>
            <button id="logout-button" class="logout-btn">Logout</button>
        </div>
    </nav>

    <main class="dashboard-main">

        <header class="dashboard-welcome">
            <h1>Welcome, <span id="welcome-student-name">[Student Name]</span>!</h1>
            <p>Manage your academic advising journey here.</p>
        </header>

        <div class="dashboard-grid">
            <section id="student-info" class="dashboard-card">
                <h2><i class="fas fa-user-circle"></i> My Information</h2>
                <p><strong>Name:</strong> <span id="info-name">[Student Name]</span></p>
                <p><strong>Matric No:</strong> <span id="info-matric">[Matric Number]</span></p>
                <p><strong>Email:</strong> <span id="info-email">[Email Address]</span></p>
                <p><strong>Degree Program:</strong> <span id="info-degree">[Degree Program]</span></p>
                <p><strong>Current GPA:</strong> <span id="info-gpa">[GPA]</span></p>
            </section>

            <section id="advisor-info" class="dashboard-card">
                <h2><i class="fas fa-user-tie"></i> My Advisor</h2>
                <p><strong>Name:</strong> <span id="advisor-name">[Advisor Name]</span></p>
                <p><strong>Email:</strong> <span id="advisor-email">[Advisor Email]</span></p>
                <p><strong>Department:</strong> <span id="advisor-dept">[Advisor Department]</span></p>
                <p><strong>Office:</strong> <span id="advisor-office">[Advisor Office]</span></p>
            </section>
        </div>

        <section id="academic-results-section" class="dashboard-card">
            <h2><i class="fas fa-graduation-cap"></i> My Academic Results</h2>
            <p>Below is a list of your official course results.</p>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Course Code</th>
                        <th>Course Title</th>
                        <th>Units</th>
                        <th>Semester</th>
                        <th>Grade</th>
                        <th>Grade Points</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <!-- The results.js script will be moved to results.html -->
            <!-- <script src="../student/results.js"></script> -->
        </section>

        <section id="notes-section" class="dashboard-card">
            <h2><i class="fas fa-clipboard-list"></i> My Advising Notes</h2>
            <ul id="notes-list" style="list-style: none; padding: 0;">
                <li style="border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <em>Loading notes...</em>
                </li>
            </ul>
        </section>

        <section id="resources-info" class="dashboard-card">
            <h2><i class="fas fa-link"></i> Advising Resources</h2>
            <ul id="resource-list">
            </ul>
        </section>

    </main>

    <script>
        // Theme toggle logic (keep as is)
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Student Dashboard DOM loaded.");

            const themeToggleButton = document.getElementById('theme-toggle-button');
            const bodyElement = document.body;

            function applyTheme() {
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'dark') {
                    bodyElement.classList.add('dark-mode');
                    if(themeToggleButton) themeToggleButton.textContent = '☀️';
                } else {
                    bodyElement.classList.remove('dark-mode');
                    if(themeToggleButton) themeToggleButton.textContent = '🌙';
                }
            }
            applyTheme();

            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', () => {
                    bodyElement.classList.toggle('dark-mode');
                    let newTheme = bodyElement.classList.contains('dark-mode') ? 'dark' : 'light';
                    themeToggleButton.textContent = newTheme === 'dark' ? '☀️' : '🌙';
                    localStorage.setItem('theme', newTheme);
                    console.log("Theme toggled. Current theme:", newTheme);
                });
            } else {
                console.warn("Theme toggle button (#theme-toggle-button) not found.");
            }

            // Logout button logic (updated for Firebase)
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async (event) => {
                    event.preventDefault();
                    console.log("Logout button clicked.");
                    try {
                        await window.firebaseAuth.signOut();
                        // Redirection handled by onAuthStateChanged in index.html
                    } catch (error) {
                        console.error("Error signing out:", error);
                        alert("Failed to log out. Please try again.");
                    }
                });
            } else { console.warn("Logout button (#logout-button) not found."); }

            // Fetch dashboard data using Firebase
            fetchStudentDashboardData();
        });

        async function fetchStudentDashboardData() {
            console.log("Fetching student dashboard data from Firestore...");
            const auth = window.firebaseAuth;
            const db = window.firebaseDb;
            const user = auth.currentUser;

            if (!user) {
                console.error("No user logged in. Redirecting to login.");
                // Redirection already handled by onAuthStateChanged in index.html
                return;
            }

            const studentUid = user.uid; // Firebase UID is the document ID

            try {
                // Fetch student profile data
                const studentDocRef = db.collection('users').doc(studentUid);
                const studentDocSnap = await studentDocRef.get();

                if (studentDocSnap.exists) {
                    const studentData = studentDocSnap.data();
                    console.log("Student Data from Firestore:", studentData);
                    populateStudentDashboard(studentData);

                    // Fetch advisor info if advisorId exists
                    if (studentData.advisorId) {
                        const advisorDocRef = db.collection('users').doc(studentData.advisorId);
                        const advisorDocSnap = await advisorDocRef.get();
                        if (advisorDocSnap.exists) {
                            const advisorData = advisorDocSnap.data();
                            console.log("Advisor Data from Firestore:", advisorData);
                            populateAdvisorInfo(advisorData);
                        } else {
                            console.warn("Advisor document not found for ID:", studentData.advisorId);
                            document.getElementById('advisor-info').innerHTML = `<h2><i class="fas fa-user-tie"></i> My Advisor</h2><p>Advisor profile not found.</p>`;
                        }
                    } else {
                        document.getElementById('advisor-info').innerHTML = `<h2><i class="fas fa-user-tie"></i> My Advisor</h2><p>No advisor assigned yet.</p>`;
                    }

                    // Fetch advising notes
                    const notesCollectionRef = db.collection('advising_notes')
                                                .where('studentId', '==', studentUid)
                                                .orderBy('created_at', 'desc'); // Order by timestamp
                    const notesSnapshot = await notesCollectionRef.get();
                    const notes = notesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Advising Notes from Firestore:", notes);
                    populateAdvisingNotes(notes);

                    // Fetch advising resources
                    const resourcesCollectionRef = db.collection('advising_resources')
                                                    .orderBy('category')
                                                    .orderBy('title');
                    const resourcesSnapshot = await resourcesCollectionRef.get();
                    const resources = resourcesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Advising Resources from Firestore:", resources);
                    populateAdvisingResources(resources);

                } else {
                    console.error("Student document not found in Firestore for UID:", studentUid);
                    alert("Your student profile could not be loaded. Please contact support.");
                    await auth.signOut(); // Sign out if profile doesn't exist
                }
            } catch (error) {
                console.error("Error fetching student dashboard data:", error);
                alert("Failed to load dashboard data. Please check your internet connection or try again later.");
                // Potentially redirect to login if it's an auth error
                if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    await auth.signOut();
                }
            }
        }

        function populateStudentDashboard(studentInfo) {
            setTextContent('welcome-student-name', studentInfo.name || 'Student');
            setTextContent('info-name', studentInfo.name || 'N/A');
            setTextContent('info-matric', studentInfo.matric_number || 'N/A');
            setTextContent('info-email', studentInfo.email || 'N/A');
            setTextContent('info-degree', studentInfo.degree?.name || 'Not Assigned');
            setTextContent('info-gpa', studentInfo.gpa !== null && studentInfo.gpa !== undefined ? studentInfo.gpa.toFixed(2) : 'N/A');
        }

        function populateAdvisorInfo(advisorInfo) {
            setTextContent('advisor-name', advisorInfo.name || 'N/A');
            setTextContent('advisor-email', advisorInfo.email || 'N/A');
            setTextContent('advisor-dept', advisorInfo.department || 'N/A');
            setTextContent('advisor-office', advisorInfo.office_location || 'N/A'); // Ensure field name matches Firestore
        }

        function populateAdvisingNotes(notes) {
            const notesListUl = document.getElementById('notes-list');
            if (!notesListUl) {
                console.error("Notes list element (#notes-list) not found!");
                return;
            }
            notesListUl.innerHTML = ''; // Clear loading message

            if (notes.length > 0) {
                notes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'note-item'; // Add a class for styling
                    li.style.borderBottom = '1px dashed var(--border-dashed)';
                    li.style.paddingBottom = '10px';
                    li.style.marginBottom = '10px';

                    const contentP = document.createElement('p');
                    contentP.textContent = note.content;
                    contentP.style.marginBottom = '5px';

                    const metaSpan = document.createElement('span');
                    metaSpan.style.fontSize = '0.85em';
                    metaSpan.style.color = 'var(--text-secondary)';
                    try {
                        const noteDate = note.created_at?.toDate(); // Convert Firestore Timestamp to Date
                        const dateString = noteDate ?
                            noteDate.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' +
                            noteDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) :
                            'Invalid Date';
                        metaSpan.textContent = `By: ${note.author_name || 'Unknown Advisor'} on ${dateString}`;
                    } catch (dateError) {
                        console.error("Error formatting date for note:", dateError, "Timestamp:", note.created_at);
                        metaSpan.textContent = `By: ${note.author_name || 'Unknown Advisor'} (timestamp error)`;
                    }
                    li.appendChild(contentP);
                    li.appendChild(metaSpan);
                    notesListUl.appendChild(li);
                });
            } else {
                notesListUl.innerHTML = '<li>No advising notes found for this student.</li>';
            }
        }

        function populateAdvisingResources(resources) {
            const resourceListUl = document.getElementById('resource-list');
            if (!resourceListUl) {
                console.error("Resource list element (#resource-list) not found!");
                return;
            }
            resourceListUl.innerHTML = ''; // Clear existing content

            if (resources.length > 0) {
                resources.forEach(resource => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = resource.url || '#';
                    a.textContent = resource.title || 'Unnamed Resource';
                    if (resource.url && resource.url !== '#') {
                        a.target = '_blank'; // Open external links in new tab
                    }
                    li.appendChild(a);
                    const span = document.createElement('span');
                    span.className = 'category'; // For styling
                    span.textContent = ` (${resource.category || 'General'})`;
                    li.appendChild(span);
                    resourceListUl.appendChild(li);
                });
            } else {
                resourceListUl.innerHTML = '<li>No advising resources available at this time.</li>';
            }
        }

        function setTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = (text === null || text === undefined) ? '' : String(text);
            } else {
                // console.warn(`Element with ID '${elementId}' not found for setTextContent.`);
            }
        }
    </script>
</body>
</html>
